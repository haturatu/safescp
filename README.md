# safescp
`scp -r` などで再帰的に大量のファイルをコピーする場合、対象はすべて一度RAMに格納されます。  
その場合はRAMへコピーされた対象ファイルのリストが格納されOOM Killerを誘発させる場合があります。 
私の環境の場合、おおよそ11万ファイルを対象としてコピーする場合に起こります。  
  
`scp`の場合、重複ファイルに関係なく実行される為、一度そのプロセスが落ちると
`rsync --ignore-existing`によって上記は解決されますが、恒久的な解決とはなりません。  
`rsync --ignore-existing`も同様に一度コピー済みとしてマーキングする必要がある場合そのリストをRAMに格納しなければ行けない為に前述のOOM Killerが発生してしまいます。  

## このスクリプトの必要性
つまりは、このスクリプトによって以下が解決されます。  

- すべてのコピー対象であるファイルをすべてリスト化し差分比較することによってコピーが中断された場合の継続処理が可能
- 単一ファイルごとに`scp`を実行し、過剰なRAM使用を防止する

このスクリプトはパスワード認証は想定しておらず、鍵認証を行うことを前提としています。  

## scpによる並列処理を行う場合のsshデーモンの設定
サーバ側での設定変更を伴う必要があります。  
並列処理として、100プロセスを`scp`によって実行する場合以下のように`/etc/ssh/sshd_config`を変更する必要があります。  
`safescp.sh`:  
```bash
SCP_PROCCES=100
```

`/etc/ssh/sshd_config`:  
```
MaxAuthTries 120
MaxSessions 120
MaxStartups 120
```
